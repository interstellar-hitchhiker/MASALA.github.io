<!DOCTYPE html>
<html>
<head>
    <title>MASALA: IBDP Exam Scheduler</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
            font-family: 'Roboto', sans-serif;
        }
        .form-control-inline {
            display: inline-block;
            width: auto;
        }
        .form-control-sm {
            width: auto;
            display: inline-block;
        }
        .placeholder {
            color: lightgray;
        }
        .card {
            margin-top: 20px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            color: #fff;
            border-radius: 50px;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            color: #fff;
            border-radius: 50px;
        }
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            color: #fff;
            border-radius: 50px;
        }
        .btn-finalize {
            background-color: #17a2b8;
            color: white;
            border-radius: 50px;
        }
        .btn {
            width: auto;
            padding: 10px 20px;
            margin: 5px 0;
        }
        #finalizedTableArea {
            margin-top: 30px;
            overflow-x: auto;
            white-space: nowrap;
        }
        #clock {
            font-size: 72px;
            text-align: center;
            margin-bottom: 20px;
        }
        #scheduleView, #finalizedView {
            display: none;
            width: 100%;
        }
        table {
            width: 90%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        thead {
            background-color: #007bff;
            color: #fff;
        }
        tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tbody tr:hover {
            background-color: #e9ecef;
        }
        th, td {
            padding: 10px;
            border: 1px solid #dee2e6;
            color: #000; /* Ensure text color is black */
        }
        .card-title {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            color: #333;
        }
        .sticky-col {
            position: -webkit-sticky;
            position: sticky;
            left: 0;
            background-color: #007bff;
            color: white;
            z-index: 1;
        }
        .sticky-col-content {
            background-color: #fff;
            border-left: 1px solid #dee2e6;
            color: #000; /* Ensure text color is black */
            z-index: 1;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const examDateInput = document.getElementById('examDate');
            const today = new Date();
            examDateInput.value = today.toISOString().split('T')[0];
            examDateInput.addEventListener('change', function() {
                this.blur();
            });
        });

        function generateSchedule() {
            const numberOfExams = parseInt(document.getElementById("numExams").value);
            const tableArea = document.getElementById("tableArea");
            const examDate = document.getElementById("examDate").value;

            if (isNaN(numberOfExams) || !examDate) {
                alert("Please enter a valid number of exams and select a date.");
                return;
            }

            if (numberOfExams < 1) {
                alert("The minimum number of exams is 1. Setting to 1.");
                document.getElementById("numExams").value = 1;
                return;
            } else if (numberOfExams > 20) {
                alert("The maximum number of exams is 20. Setting to 20.");
                document.getElementById("numExams").value = 20;
                return;
            }

            tableArea.innerHTML = "";
            let tableHTML = `
                <div class="mt-3">
                    <div style="overflow-x:auto;">
                        <table class='table table-bordered table-hover table-striped'>
                            <thead class="thead-dark">
                                <tr>
                                    <th class="sticky-col">Exam Date: ${examDate}</th>`;
            for (let i = 1; i <= numberOfExams; i++) {
                tableHTML += `<th contenteditable='true' class='placeholder' onfocus="this.classList.remove('placeholder')" onblur="if(this.innerText === '') { this.innerText='e.g. English B Paper 1 HL'; this.classList.add('placeholder'); }">e.g. English B Paper 1 HL</th>`;
            }
            tableHTML += `
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td class="sticky-col sticky-col-content">Exam Duration</td>`;
            for (let i = 1; i <= numberOfExams; i++) {
                tableHTML += `
                    <td>
                        <input type='number' class='form-control form-control-sm' id='durationHours${i}' placeholder='Hours' min='0' max='4' value='0' onchange='calculateTimes(${i})' oninput='updateHrText(${i})'> <span id='hrText${i}'>hr</span>
                        <input type='number' class='form-control form-control-sm' id='durationMinutes${i}' placeholder='Minutes' min='0' max='60' value='0' onchange='calculateTimes(${i})'> mins
                    </td>`;
            }
            tableHTML += `</tr><tr><td class="sticky-col sticky-col-content">Reading Time Allocated</td>`;
            for (let i = 1; i <= numberOfExams; i++) {
                tableHTML += `
                    <td>
                        <input type='checkbox' id='noReading${i}' onchange='calculateTimes(${i})'> N/A
                        <input type='number' class='form-control form-control-sm' id='readingTime${i}' placeholder='Minutes' min='0' max='20' value='5' onchange='calculateTimes(${i})'>
                    </td>`;
            }
            tableHTML += `</tr><tr><td class="sticky-col sticky-col-content">Start Time</td>`;
            for (let i = 1; i <= numberOfExams; i++) {
                tableHTML += `<td><input type='time' class='form-control' id='startTime${i}' onchange='calculateTimes(${i})'></td>`;
            }
            tableHTML += `</tr><tr><td class="sticky-col sticky-col-content">Reading Period</td>`;
            for (let i = 1; i <= numberOfExams; i++) {
                tableHTML += `<td><div id='readingTimeDisplay${i}'></div></td>`;
            }
            tableHTML += `</tr><tr><td class="sticky-col sticky-col-content">30 Mins Remaining</td>`;
            for (let i = 1; i <= numberOfExams; i++) {
                tableHTML += `<td><input type='time' class='form-control' id='thirtyMin${i}' readonly></td>`;
            }
            tableHTML += `</tr><tr><td class="sticky-col sticky-col-content">5 Mins Remaining</td>`;
            for (let i = 1; i <= numberOfExams; i++) {
                tableHTML += `<td><input type='time' class='form-control' id='fiveMin${i}' readonly></td>`;
            }
            tableHTML += `</tr><tr><td class="sticky-col sticky-col-content">End</td>`;
            for (let i = 1; i <= numberOfExams; i++) {
                tableHTML += `<td><input type='time' class='form-control' id='endTime${i}' readonly></td>`;
            }
            tableHTML += `</tr><tr><td class="sticky-col sticky-col-content">Accommodations (%)</td>`;
            for (let i = 1; i <= numberOfExams; i++) {
                tableHTML += `
                    <td>
                        <input type='checkbox' id='noAccommodations${i}' onchange='toggleAccommodationInput(${i})' checked> N/A
                        <input type='number' class='form-control form-control-sm' id='accommodations${i}' placeholder='%' min='0' max='100' value='0' onchange='calculateAccommodations(${i})'>
                        <div id='accommodationEndTime${i}'></div>
                    </td>`;
            }
            tableHTML += `</tr></tbody></table>
            <div id="additionalButtons" class="mt-3">
                <button class="btn btn-primary" onclick="exportToExcel()">Download to Excel</button>
                <button class="btn btn-finalize ml-2" onclick="displayFinalizedTable()">Finalized Table Web View</button>
            </div>
            </div>
            `;

            tableArea.innerHTML = tableHTML;
        }

        function updateHrText(index) {
            const hours = document.getElementById(`durationHours${index}`).value;
            const hrText = document.getElementById(`hrText${index}`);
            hrText.textContent = hours == 1 ? "hr" : "hrs";
        }

        function calculateTimes(index) {
            const hours = parseInt(document.getElementById(`durationHours${index}`).value);
            const minutes = parseInt(document.getElementById(`durationMinutes${index}`).value);
            const durationMinutes = hours * 60 + minutes;
            const readingTime = document.getElementById(`noReading${index}`).checked ? 0 : parseInt(document.getElementById(`readingTime${index}`).value);
            const startTime = moment(document.getElementById(`startTime${index}`).value, 'HH:mm');
            if (!isNaN(durationMinutes) && startTime.isValid()) {
                const examStartTime = startTime.clone().add(readingTime, 'minutes');
                const endTime = examStartTime.clone().add(durationMinutes, 'minutes');
                const thirtyMin = endTime.clone().subtract(30, 'minutes').format('HH:mm');
                const fiveMin = endTime.clone().subtract(5, 'minutes').format('HH:mm');
                const readingDisplay = document.getElementById(`noReading${index}`).checked ? "N/A" : `${startTime.format('HH:mm')} - ${examStartTime.format('HH:mm')}`;

                document.getElementById(`readingTimeDisplay${index}`).textContent = readingDisplay;
                document.getElementById(`thirtyMin${index}`).value = thirtyMin;
                document.getElementById(`fiveMin${index}`).value = fiveMin;
                document.getElementById(`endTime${index}`).value = endTime.format('HH:mm');
                
                // Update accommodation end time if applicable
                calculateAccommodations(index);
            }
        }

        function calculateAccommodations(index) {
            const endTime = document.getElementById(`endTime${index}`).value;
            const accommodationsCheckbox = document.getElementById(`noAccommodations${index}`);
            const accommodations = parseInt(document.getElementById(`accommodations${index}`).value);
            const accommodationEndTime = document.getElementById(`accommodationEndTime${index}`);
            
            if (accommodationsCheckbox.checked) {
                accommodationEndTime.textContent = '';
            } else if (endTime && accommodations > 0) {
                const endMoment = moment(endTime, 'HH:mm');
                const durationMinutes = (parseInt(document.getElementById(`durationHours${index}`).value) * 60) + parseInt(document.getElementById(`durationMinutes${index}`).value);
                const additionalTime = durationMinutes * (accommodations / 100);
                const newEndTime = endMoment.clone().add(additionalTime, 'minutes').format('HH:mm');
                accommodationEndTime.textContent = newEndTime;
            } else {
                accommodationEndTime.textContent = 'N/A';
            }
        }

        function displayFinalizedTable() {
            const numberOfExams = parseInt(document.getElementById("numExams").value);
            const examDate = document.getElementById("examDate").value;

            if (isNaN(numberOfExams) || !examDate) {
                alert("Please enter a valid number of exams and select a date.");
                return;
            }

            // Hide scheduling view and show finalized view
            document.getElementById("scheduleView").style.display = "none";
            document.getElementById("finalizedView").style.display = "block";

            // Show the clock
            const clockArea = document.getElementById("clockArea");
            clockArea.innerHTML = '<div id="clock"></div>';
            updateClock();
            setInterval(updateClock, 1000);

            const finalizedTableArea = document.getElementById("finalizedTableArea");
            finalizedTableArea.innerHTML = "";
            let tableHTML = `
                <div class="mt-3">
                    <table class='table table-bordered table-hover table-striped'>
                        <thead class="thead-dark">
                            <tr>
                                <th class="sticky-col">Exam Date: ${examDate}</th>`;
            for (let i = 1; i <= numberOfExams; i++) {
                const subject = document.querySelector(`#tableArea th:nth-child(${i + 1})`).innerText.trim();
                tableHTML += `<th>${subject}</th>`;
            }
            tableHTML += `
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td class="sticky-col sticky-col-content">Exam Duration</td>`;
            for (let i = 1; i <= numberOfExams; i++) {
                const durationHours = document.getElementById(`durationHours${i}`).value;
                const durationMinutes = document.getElementById(`durationMinutes${i}`).value;
                const duration = `${durationHours > 0 ? durationHours + (durationHours == 1 ? ' hr ' : ' hrs ') : ''}${durationMinutes > 0 ? durationMinutes + ' mins' : ''}`;
                tableHTML += `<td>${duration}</td>`;
            }
            tableHTML += `</tr><tr><td class="sticky-col sticky-col-content">Reading Time Allocated</td>`;
            for (let i = 1; i <= numberOfExams; i++) {
                const readingTime = document.getElementById(`noReading${i}`).checked ? "N/A" : document.getElementById(`readingTime${i}`).value + " mins";
                tableHTML += `<td>${readingTime}</td>`;
            }
            tableHTML += `</tr><tr><td class="sticky-col sticky-col-content">Start Time</td>`;
            for (let i = 1; i <= numberOfExams; i++) {
                const startTime = document.getElementById(`startTime${i}`).value;
                tableHTML += `<td id='startTime${i}Cell'>${moment(startTime, 'HH:mm').format('HH:mm')}</td>`;
            }
            tableHTML += `</tr><tr><td class="sticky-col sticky-col-content">Reading Period</td>`;
            for (let i = 1; i <= numberOfExams; i++) {
                const readingDisplay = document.getElementById(`noReading${i}`).checked ? "N/A" : document.getElementById(`readingTimeDisplay${i}`).innerText;
                tableHTML += `<td id='readingPeriod${i}Cell'>${readingDisplay}</td>`;
            }
            tableHTML += `</tr><tr><td class="sticky-col sticky-col-content">30 Mins Remaining</td>`;
            for (let i = 1; i <= numberOfExams; i++) {
                const thirtyMin = document.getElementById(`thirtyMin${i}`).value;
                tableHTML += `<td id='thirtyMin${i}Cell'>${moment(thirtyMin, 'HH:mm').format('HH:mm')}</td>`;
            }
            tableHTML += `</tr><tr><td class="sticky-col sticky-col-content">5 Mins Remaining</td>`;
            for (let i = 1; i <= numberOfExams; i++) {
                const fiveMin = document.getElementById(`fiveMin${i}`).value;
                tableHTML += `<td id='fiveMin${i}Cell'>${moment(fiveMin, 'HH:mm').format('HH:mm')}</td>`;
            }
            tableHTML += `</tr><tr><td class="sticky-col sticky-col-content">End</td>`;
            for (let i = 1; i <= numberOfExams; i++) {
                const endTime = document.getElementById(`endTime${i}`).value;
                tableHTML += `<td id='endTime${i}Cell'>${moment(endTime, 'HH:mm').format('HH:mm')}</td>`;
            }
            tableHTML += `</tr><tr><td class="sticky-col sticky-col-content">Accommodations (%)</td>`;
            for (let i = 1; i <= numberOfExams; i++) {
                const accommodations = document.getElementById(`noAccommodations${i}`).checked ? "N/A" : document.getElementById(`accommodationEndTime${i}`).innerText;
                tableHTML += `<td>${accommodations}</td>`;
            }
            tableHTML += `</tr></tbody></table>
                </div>`;

            finalizedTableArea.innerHTML = tableHTML;

            setInterval(updateHighlightedCells, 1000); // Update cell highlighting every second
        }

        function updateClock() {
            const now = moment();
            const timeString = now.format('HH:mm:ss');
            document.getElementById('clock').textContent = timeString;
        }

        function updateHighlightedCells() {
            const now = moment().format('HH:mm');

            for (let i = 1; i <= document.getElementById("numExams").value; i++) {
                const startTime = document.getElementById(`startTime${i}`).value;
                const thirtyMin = document.getElementById(`thirtyMin${i}`).value;
                const fiveMin = document.getElementById(`fiveMin${i}`).value;
                const endTime = document.getElementById(`endTime${i}`).value;

                const startTimeCell = document.getElementById(`startTime${i}Cell`);
                const readingPeriodCell = document.getElementById(`readingPeriod${i}Cell`);
                const thirtyMinCell = document.getElementById(`thirtyMin${i}Cell`);
                const fiveMinCell = document.getElementById(`fiveMin${i}Cell`);
                const endTimeCell = document.getElementById(`endTime${i}Cell`);

                if (startTime === now) {
                    startTimeCell.style.backgroundColor = "green";
                    readingPeriodCell.style.backgroundColor = "#66ff66"; // Complementary green
                } else {
                    startTimeCell.style.backgroundColor = "";
                    readingPeriodCell.style.backgroundColor = "";
                }

                if (thirtyMin === now) {
                    thirtyMinCell.style.backgroundColor = "#ffc107"; // Light amber
                } else {
                    thirtyMinCell.style.backgroundColor = "";
                }

                if (fiveMin === now) {
                    fiveMinCell.style.backgroundColor = "#ff9800"; // Darker amber
                } else {
                    fiveMinCell.style.backgroundColor = "";
                }

                if (endTime === now) {
                    endTimeCell.style.backgroundColor = "red";
                } else {
                    endTimeCell.style.backgroundColor = "";
                }
            }
        }

        function exportToExcel() {
            const examDate = document.getElementById("examDate").value || 'Set Exam Date';
            const table = document.querySelector("table");
            const headers = ["Exam Duration", "Reading Time Allocated", "Start Time", "Reading Period", "30 Mins Remaining", "5 Mins Remaining", "End", "Accommodations (%)"];
            const data = [[examDate, ...Array.from(table.rows[0].cells).slice(1).map(cell => cell.innerText.trim())]];

            const numberOfExams = parseInt(document.getElementById("numExams").value);

            for (let i = 0; i < headers.length; i++) {
                const row = [headers[i]];
                for (let j = 1; j <= numberOfExams; j++) {
                    let value = "";
                    switch (i) {
                        case 0:
                            const hours = document.getElementById(`durationHours${j}`).value;
                            const minutes = document.getElementById(`durationMinutes${j}`).value;
                            value = `${hours > 0 ? hours + (hours == 1 ? ' hr ' : ' hrs ') : ''}${minutes > 0 ? minutes + ' mins' : ''}`;
                            break;
                        case 1:
                            value = document.getElementById(`noReading${j}`).checked ? "N/A" : document.getElementById(`readingTime${j}`).value + " mins";
                            break;
                        case 2:
                            value = moment(document.getElementById(`startTime${j}`).value, 'HH:mm').format('HH:mm');
                            break;
                        case 3:
                            const startDisplay = moment(document.getElementById(`startTime${j}`).value, 'HH:mm').format('HH:mm');
                            const endDisplay = moment(document.getElementById(`startTime${j}`).value, 'HH:mm').add(parseInt(document.getElementById(`readingTime${j}`).value), 'minutes').format('HH:mm');
                            value = document.getElementById(`noReading${j}`).checked ? "N/A" : `${startDisplay} - ${endDisplay}`;
                            break;
                        case 4:
                            value = moment(document.getElementById(`thirtyMin${j}`).value, 'HH:mm').format('HH:mm');
                            break;
                        case 5:
                            value = moment(document.getElementById(`fiveMin${j}`).value, 'HH:mm').format('HH:mm');
                            break;
                        case 6:
                            value = moment(document.getElementById(`endTime${j}`).value, 'HH:mm').format('HH:mm');
                            break;
                        case 7:
                            value = document.getElementById(`noAccommodations${j}`).checked ? "N/A" : moment(document.getElementById(`accommodationEndTime${j}`).innerText, 'HH:mm').format('HH:mm');
                            break;
                    }
                    row.push(value);
                }
                data.push(row);
            }

            const worksheet = XLSX.utils.aoa_to_sheet(data);

            // Set column widths
            const columnWidths = Array(data[0].length).fill({ wpx: 200 });
            worksheet['!cols'] = columnWidths;

            // Style alternating columns
            const alternatingColors = ['FFFFFF', 'D3D3D3']; // Define alternating colors
            for (let c = 0; c < data[0].length; c++) {
                for (let r = 0; r < data.length; r++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: r, c: c });
                    if (!worksheet[cellAddress].s) worksheet[cellAddress].s = {}; // Initialize style object if not present
                    worksheet[cellAddress].s.fill = {
                        patternType: 'solid',
                        fgColor: { rgb: alternatingColors[c % 2] }
                    };
                }
            }

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Exam Schedule");

            const filename = `exam-schedule-${examDate.replace(/-/g, '')}.xlsx`;
            XLSX.writeFile(workbook, filename);
        }

        function showScheduleView() {
            document.getElementById("scheduleView").style.display = "block";
            document.getElementById("finalizedView").style.display = "none";
        }

        function toggleAccommodationInput(index) {
            const accommodationsCheckbox = document.getElementById(`noAccommodations${index}`);
            const accommodationsInput = document.getElementById(`accommodations${index}`);
            accommodationsInput.disabled = accommodationsCheckbox.checked;
            if (accommodationsCheckbox.checked) {
                accommodationsInput.value = 0;
                document.getElementById(`accommodationEndTime${index}`).textContent = '';
            } else {
                accommodationsInput.value = '';
            }
            calculateAccommodations(index);
        }
    </script>
</head>
<body onload="showScheduleView()">
    <div id="scheduleView" class="container-fluid">
        <div class="card">
            <div class="card-body">
                <h1 class="card-title">MASALA: IBDP Exam Scheduler</h1>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="examDate">What is the date you are scheduling the exams for?</label>
                        <input type="date" id="examDate" class="form-control mb-3">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="numExams">How many exams are being scheduled for the given day?</label>
                        <input type="number" id="numExams" class="form-control mb-3" placeholder="Enter number of exams" min="1" max="20" value="1">
                    </div>
                </div>
                <button class="btn btn-success" onclick="generateSchedule()">Create Schedule Table</button>
                <div id="tableArea" class="mt-3"></div>
            </div>
        </div>
    </div>

    <div id="finalizedView" class="container-fluid">
        <div class="card">
            <div class="card-body">
                <button class="btn btn-secondary mb-3" onclick="showScheduleView()">Return to Scheduling</button>
                <div id="clockArea" class="mb-5"></div>
                <div id="finalizedTableArea" class="mt-5"></div>
            </div>
        </div>
    </div>
</body>
</html>
